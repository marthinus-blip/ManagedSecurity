name: AOT Compliance Build

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Install dependencies (zlib static)
      run: sudo apt-get update && sudo apt-get install -y zlib1g-dev

    - name: Build and Pack Libraries (Local Feed)
      run: |
        mkdir -p local-packages
        # Build first to ensure DLLs exist
        dotnet build ManagedSecurity.Common/ManagedSecurity.Common.csproj -c Release
        dotnet build ManagedSecurity.Core/ManagedSecurity.Core.csproj -c Release
        # Pack using the existing builds
        dotnet pack ManagedSecurity.Common/ManagedSecurity.Common.csproj -c Release --no-build -o ./local-packages
        dotnet pack ManagedSecurity.Core/ManagedSecurity.Core.csproj -c Release --no-build -o ./local-packages

    - name: Publish NativeAOT (Linux)
      run: |
        dotnet publish ManagedSecurity.Test/ManagedSecurity.Test.csproj \
        -c Release -r linux-x64 --self-contained true /p:PublishAot=true

    - name: Run AOT Compliance Tests (Linux)
      run: ./ManagedSecurity.Test/bin/Release/net8.0/linux-x64/publish/ManagedSecurity.Test

    - name: Publish Consumer Demo (Linux)
      run: |
        dotnet publish ManagedSecurity.ConsumerDemo/ManagedSecurity.ConsumerDemo.csproj \
        -c Release -r linux-x64 --self-contained true /p:PublishAot=true

    - name: Run Consumer Demo (Linux)
      run: ./ManagedSecurity.ConsumerDemo/bin/Release/net8.0/linux-x64/publish/ManagedSecurity.ConsumerDemo

  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Build and Pack Libraries (Local Feed)
      shell: pwsh
      run: |
        if (!(Test-Path local-packages)) { mkdir local-packages }
        # Build first to ensure DLLs exist
        dotnet build ManagedSecurity.Common/ManagedSecurity.Common.csproj -c Release
        dotnet build ManagedSecurity.Core/ManagedSecurity.Core.csproj -c Release
        # Pack using the existing builds
        dotnet pack ManagedSecurity.Common/ManagedSecurity.Common.csproj -c Release --no-build -o ./local-packages
        dotnet pack ManagedSecurity.Core/ManagedSecurity.Core.csproj -c Release --no-build -o ./local-packages

    - name: Publish NativeAOT (Windows)
      run: |
        dotnet publish ManagedSecurity.Test/ManagedSecurity.Test.csproj `
        -c Release -r win-x64 --self-contained true /p:PublishAot=true

    - name: Run AOT Compliance Tests (Windows)
      run: .\ManagedSecurity.Test\bin\Release\net8.0\win-x64\publish\ManagedSecurity.Test.exe

    - name: Publish Consumer Demo (Windows)
      run: |
        dotnet publish ManagedSecurity.ConsumerDemo/ManagedSecurity.ConsumerDemo.csproj `
        -c Release -r win-x64 --self-contained true /p:PublishAot=true

    - name: Run Consumer Demo (Windows)
      run: .\ManagedSecurity.ConsumerDemo\bin\Release\net8.0\win-x64\publish\ManagedSecurity.ConsumerDemo.exe

    - name: Upload Windows Binary for Wine Testing
      uses: actions/upload-artifact@v4
      with:
        name: ManagedSecurity-Windows-AOT
        path: |
          ManagedSecurity.Test/bin/Release/net8.0/win-x64/publish/ManagedSecurity.Test.exe
          ManagedSecurity.ConsumerDemo/bin/Release/net8.0/win-x64/publish/ManagedSecurity.ConsumerDemo.exe
