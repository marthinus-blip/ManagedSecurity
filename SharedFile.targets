<Project>
  <Target Name="AutoVersion" BeforeTargets="PrepareForBuild">
    <!-- 1. Capture Git Tag -->
    <Exec Command="git describe --tags --always" ConsoleToMSBuild="true" IgnoreExitCode="true">
      <Output TaskParameter="ConsoleOutput" PropertyName="RawTag" />
    </Exec>

    <PropertyGroup>
      <!-- 2. Clean 'v' and extract the numeric prefix (e.g., 1.2.3) -->
      <CleanTag>$(RawTag.TrimStart('v'))</CleanTag>
       <!-- Fallback if tag is empty -->
      <CleanTag Condition="'$(CleanVersion)' == ''">0.0.1</CleanTag>
      <VersionPrefix>$([System.Text.RegularExpressions.Regex]::Match($(CleanTag), '^[0-9]+\.[0-9]+\.[0-9]+'))</VersionPrefix>
      
      <!-- 3. Define the Suffix -->
      <!-- If on CI (GitHub Actions), use the build number. Otherwise, use a local timestamp. -->
      <VersionSuffix Condition="'$(GITHUB_RUN_NUMBER)' != ''">ci.$(GITHUB_RUN_NUMBER)</VersionSuffix>
      <VersionSuffix Condition="'$(VersionSuffix)' == '' AND '$(Configuration)' == 'Debug'">dev.$([System.DateTime]::Now.ToString("yyyyMMdd-HHmm"))</VersionSuffix>

      <FileVersion>$(VersionPrefix)</FileVersion>
      <AssemblyVersion>$(VersionPrefix)</AssemblyVersion>
      <Version>$(VersionPrefix)-$(VersionSuffix)</Version>
      <PackageVersion>$(VersionPrefix)-$(VersionSuffix)</PackageVersion>
    </PropertyGroup>

    <Message Text="Built Version: $(VersionPrefix)-$(VersionSuffix)" Importance="high" />
  </Target>
</Project>